#!/bin/sh

set -euo pipefail


#======================================================================================================================
# Check for target platform
#======================================================================================================================

if [ -z "${TARGETPLATFORM}" ] ; then
    _error "Target platform not set."
fi


#======================================================================================================================
# Get correct installer for target platform
#======================================================================================================================

case "${TARGETPLATFORM}" in
    "linux/amd64")
        ARCH="amd64"
        ;;
    "linux/arm/v7")
        ARCH="armhf"
        ;;
    "linux/arm64")
        ARCH="aarch64"
        ;;
    *)
esac

if [ -z "${ARCH}" ] ; then
    _error "Unsupported target platform: ${TARGETPLATFORM}."
fi


#======================================================================================================================
# Download and run S6 installer
#======================================================================================================================

cd /tmp

URL="https://github.com/just-containers/s6-overlay/releases/download/v${S6_VERSION}/s6-overlay-${ARCH}-installer"
_echo "Downloading ${URL}..."
wget -O installer ${URL} && chmod +x installer
_done

_echo "Installing S6 v${S6_VERSION}..."
./installer /

if [ -d /etc/s6 ] ; then
    _done
else
    _error "S6 not installed."
fi
