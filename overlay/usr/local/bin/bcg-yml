#!/bin/sh

set -euo pipefail


#======================================================================================================================
# Check arguments.
#   1   Yaml file
#   2   Prefix (optional)
#======================================================================================================================

[[ -z "${1-}" ]] && bcg-error "You must provide a file." "bcg-yml"
FILE=${1}

[[ -n "${2}" ]] && PREFIX="${2}_"


#======================================================================================================================
# Ensure the file exists.
#======================================================================================================================

[[ ! -f "${FILE}" ]] && bcg-error "'${FILE}' does not exist." "bcg-yml"


#======================================================================================================================
# Parse simple Yaml file.
# See https://stackoverflow.com/a/21189044/8199362
#======================================================================================================================

parse() {

    S='[[:space:]]*'
    W='[a-zA-Z0-9_]*'
    FS=$(echo @|tr @ '\034')

    sed -ne "s|^\(${S}\):|\1|" \
        -e "s|^\(${S}\)\(${W}\)${S}:${S}[\"']\(.*\)[\"']${S}\$|\1${FS}\2${FS}\3|p" \
        -e "s|^\(${S}\)\(${W}\)${S}:${S}\(.*\)${S}\$|\1${FS}\2${FS}\3|p" ${FILE} |

    OUTPUT=$(awk -F${FS} '{
        indent = length($1)/2;
        vname[indent] = $2;
        for (i in vname) {if (i > indent) {delete vname[i]}}
        if (length($3) > 0) {
            vn=""; for (i=0; i<indent; i++) {vn=(vn)(vname[i])("_")}
            printf("%s%s%s=\"%s\"\n", "'${PREFIX-}'", vn, $2, $3);
        }
    }')

}


parse ${FILE} ${PREFIX-}
